<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Google Image Scraper</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; }
    textarea, input { width: 100%; font-size: 1rem; margin-bottom: 1rem; }
    textarea { height: 200px; }
    button { padding: 0.5rem 1rem; margin-top: 1rem; }
    #results img { max-width: 200px; margin: 10px; display: inline-block; }
    #status { margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Paste Google Image URLs</h1>

  <!-- ðŸ†• Textbox that will show data from n8n -->
  <label for="textbox">Live Data from n8n:</label>
  <input id="textbox" type="text" readonly />

  <textarea id="urls" placeholder="Paste one Google image search URL per line..."></textarea>
  <br>
  <button onclick="extractImages()">Extract Images</button>
  <div id="status"></div>
  <div id="results"></div>

  <script>
    async function fetchHTML(url, retries = 5, delay = 1000) {
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
          const res = await fetch(proxyUrl);
          const data = await res.json();
          if (!data.contents.includes('<html')) {
            throw new Error('Invalid HTML content');
          }
          return data.contents;
        } catch (e) {
          console.warn(`Attempt ${attempt} failed for ${url}`, e);
          if (attempt < retries) {
            await new Promise(resolve => setTimeout(resolve, delay));
          } else {
            console.error(`Failed to fetch ${url} after ${retries} attempts`);
            return null;
          }
        }
      }
    }

    function extractSecondImageSrc(html) {
      try {
        const matches = [...html.matchAll(/<img[^>]+src="([^"]+)"/g)];
        for (let i = 1; i < matches.length; i++) {
          const src = matches[i][1];
          if (!src.includes('googlelogo')) {
            return src.startsWith('http') ? src : 'https://www.google.com' + src;
          }
        }
      } catch (err) {
        console.error("Error parsing image src", err);
      }
      return null;
    }

    async function extractImages() {
      const urls = document.getElementById('urls').value.trim().split('\n');
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';
      document.getElementById('status').innerText = 'Fetching images...';

      for (const url of urls) {
        const html = await fetchHTML(url);
        if (!html) {
          const msg = document.createElement('p');
          msg.innerText = `Failed to fetch ${url} after retries`;
          resultsDiv.appendChild(msg);
          continue;
        }
        const src = extractSecondImageSrc(html);
        if (src) {
          const img = document.createElement('img');
          img.src = src;
          resultsDiv.appendChild(img);
        } else {
          const msg = document.createElement('p');
          msg.innerText = `No second usable image found in ${url}`;
          resultsDiv.appendChild(msg);
        }
      }

      document.getElementById('status').innerText = 'Done!';
    }

    // ðŸ†• Fetch from n8n backend every 3 seconds and update the input box
    async function getData() {
      try {
        const res = await fetch('https://barebones-n8n-server.onrender.com/data');
        const json = await res.json();
        document.getElementById('textbox').value = json.text || '';
      } catch (e) {
        console.error('Could not fetch n8n data:', e);
      }
    }

    // Start the fetch loop
    setInterval(getData, 3000);
    getData(); // run once at page load
  </script>
</body>
</html>
